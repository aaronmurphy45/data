2022-05-06 04:20:48.691 UTC,"postgres","postgres",2769,"192.168.56.1:55311",6274a220.ad1,2,"idle",2022-05-06 04:20:48 UTC,4/886,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-03-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-06-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-09-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-03-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-06-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-09-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-03-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-06-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-09-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-03-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-06-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-09-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-03-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-06-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-09-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 04:20:48.691 UTC,"postgres","postgres",2769,"192.168.56.1:55311",6274a220.ad1,3,"DROP TABLE",2022-05-06 04:20:48 UTC,4/886,0,ERROR,42P01,"table ""payments"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-03-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-06-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-09-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-03-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-06-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-09-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-03-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-06-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-09-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-03-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-06-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-09-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-03-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-06-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-09-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 04:20:49.338 UTC,"postgres","postgres",2769,"192.168.56.1:55311",6274a220.ad1,4,"idle",2022-05-06 04:20:48 UTC,4/887,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 04:20:49.344 UTC,"postgres","postgres",2769,"192.168.56.1:55311",6274a220.ad1,5,"idle",2022-05-06 04:20:48 UTC,4/888,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-03-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-06-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-09-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-03-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-06-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-09-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-03-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-06-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-09-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-03-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-06-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-09-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-03-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-06-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-09-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 04:20:49.344 UTC,"postgres","postgres",2769,"192.168.56.1:55311",6274a220.ad1,6,"DROP TABLE",2022-05-06 04:20:48 UTC,4/888,0,ERROR,42P01,"table ""payments"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-03-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-06-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-09-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-03-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-06-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-09-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-03-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-06-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-09-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-03-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-06-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-09-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-03-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-06-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-09-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 04:20:49.976 UTC,"postgres","postgres",2769,"192.168.56.1:55311",6274a220.ad1,7,"idle",2022-05-06 04:20:48 UTC,4/889,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 04:20:49.983 UTC,"postgres","postgres",2769,"192.168.56.1:55311",6274a220.ad1,8,"idle",2022-05-06 04:20:48 UTC,4/890,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-03-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-06-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-09-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-03-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-06-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-09-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-03-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-06-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-09-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-03-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-06-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-09-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-03-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-06-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-09-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 04:20:49.983 UTC,"postgres","postgres",2769,"192.168.56.1:55311",6274a220.ad1,9,"DROP TABLE",2022-05-06 04:20:48 UTC,4/890,0,ERROR,42P01,"table ""payments"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-03-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-06-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-09-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-03-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-06-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-09-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-03-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-06-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-09-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-03-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-06-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-09-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-03-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-06-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-09-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 04:21:00.653 UTC,"postgres","postgres",2769,"192.168.56.1:55311",6274a220.ad1,10,"idle",2022-05-06 04:20:48 UTC,4/891,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 04:21:00.658 UTC,"postgres","postgres",2769,"192.168.56.1:55311",6274a220.ad1,11,"idle",2022-05-06 04:20:48 UTC,4/892,0,LOG,00000,"statement: 


/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-03-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-06-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-09-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-03-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-06-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-09-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-03-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-06-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-09-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-03-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-06-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-09-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-03-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-06-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-09-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 04:21:00.658 UTC,,,1347,,6273c873.543,43,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 04:21:00.697 UTC,"postgres","postgres",2769,"192.168.56.1:55311",6274a220.ad1,12,"CREATE TABLE",2022-05-06 04:20:48 UTC,4/892,943,ERROR,42P17,"partition ""payments_q2_2017"" would overlap partition ""payments_q1_2017""",,,,,,"


/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-03-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-06-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-09-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-03-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-06-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-09-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-03-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-06-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-09-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-03-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-06-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-09-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-03-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-06-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-09-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",2149,,"","client backend",,0
2022-05-06 11:36:27.385 UTC,"postgres","postgres",4304,"192.168.56.1:55683",6275083b.10d0,1,"idle",2022-05-06 11:36:27 UTC,4/1096,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 11:36:27.387 UTC,"postgres","postgres",4304,"192.168.56.1:55683",6275083b.10d0,2,"idle",2022-05-06 11:36:27 UTC,4/1097,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 11:36:27.388 UTC,"postgres","postgres",4304,"192.168.56.1:55683",6275083b.10d0,3,"DROP TABLE",2022-05-06 11:36:27 UTC,4/1097,0,ERROR,42P01,"table ""payments"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 11:36:36.320 UTC,"postgres","postgres",4304,"192.168.56.1:55683",6275083b.10d0,4,"idle",2022-05-06 11:36:27 UTC,4/1098,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 11:36:36.329 UTC,"postgres","postgres",4304,"192.168.56.1:55683",6275083b.10d0,5,"idle",2022-05-06 11:36:27 UTC,4/1099,0,LOG,00000,"statement: 
/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 11:36:36.329 UTC,,,1347,,6273c873.543,44,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 11:36:36.358 UTC,"postgres","postgres",4304,"192.168.56.1:55683",6275083b.10d0,6,"CREATE TABLE",2022-05-06 11:36:27 UTC,4/1099,944,ERROR,42P07,"relation ""payments_q3_2017"" already exists",,,,,,"
/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 11:36:55.588 UTC,"postgres","postgres",4304,"192.168.56.1:55683",6275083b.10d0,7,"idle",2022-05-06 11:36:27 UTC,4/1100,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 11:36:55.593 UTC,"postgres","postgres",4304,"192.168.56.1:55683",6275083b.10d0,8,"idle",2022-05-06 11:36:27 UTC,4/1101,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 11:36:55.593 UTC,"postgres","postgres",4304,"192.168.56.1:55683",6275083b.10d0,9,"DROP TABLE",2022-05-06 11:36:27 UTC,4/1101,0,ERROR,42P01,"table ""payments"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:04:12.761 UTC,"postgres","postgres",4401,"192.168.56.1:55819",62750ebc.1131,1,"idle",2022-05-06 12:04:12 UTC,4/1213,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:04:12.764 UTC,"postgres","postgres",4401,"192.168.56.1:55819",62750ebc.1131,2,"idle",2022-05-06 12:04:12 UTC,4/1214,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
  
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:04:12.764 UTC,"postgres","postgres",4401,"192.168.56.1:55819",62750ebc.1131,3,"DROP TABLE",2022-05-06 12:04:12 UTC,4/1214,0,ERROR,42P01,"table ""payments"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure';
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
  
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:07:22.012 UTC,"postgres","postgres",4415,"192.168.56.1:55833",62750f79.113f,1,"idle",2022-05-06 12:07:21 UTC,4/1228,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:07:22.014 UTC,"postgres","postgres",4415,"192.168.56.1:55833",62750f79.113f,2,"idle",2022-05-06 12:07:21 UTC,4/1229,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:07:22.014 UTC,"postgres","postgres",4415,"192.168.56.1:55833",62750f79.113f,3,"DROP TABLE",2022-05-06 12:07:21 UTC,4/1229,0,ERROR,42P01,"table ""payments"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:07:28.215 UTC,"postgres","postgres",4415,"192.168.56.1:55833",62750f79.113f,4,"idle",2022-05-06 12:07:21 UTC,4/1230,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:07:28.220 UTC,"postgres","postgres",4415,"192.168.56.1:55833",62750f79.113f,5,"idle",2022-05-06 12:07:21 UTC,4/1231,0,LOG,00000,"statement: 

/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:07:28.221 UTC,,,1347,,6273c873.543,45,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:07:28.258 UTC,"postgres","postgres",4415,"192.168.56.1:55833",62750f79.113f,6,"CREATE TABLE",2022-05-06 12:07:21 UTC,4/1231,946,ERROR,42P07,"relation ""payments_q3_2017"" already exists",,,,,,"

/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:10:22.399 UTC,"postgres","postgres",4425,"192.168.56.1:55861",6275102e.1149,1,"idle",2022-05-06 12:10:22 UTC,4/1247,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:10:22.401 UTC,"postgres","postgres",4425,"192.168.56.1:55861",6275102e.1149,2,"idle",2022-05-06 12:10:22 UTC,4/1248,0,LOG,00000,"statement: 
DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;

",,,,,,,,,"","client backend",,0
2022-05-06 12:10:22.401 UTC,"postgres","postgres",4425,"192.168.56.1:55861",6275102e.1149,3,"DROP TABLE",2022-05-06 12:10:22 UTC,4/1248,0,ERROR,42P01,"table ""payments_q1_2017"" does not exist",,,,,,"
DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;

",,,"","client backend",,0
2022-05-06 12:10:58.600 UTC,"postgres","postgres",4429,"192.168.56.1:55863",62751052.114d,1,"idle",2022-05-06 12:10:58 UTC,4/1252,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:10:58.602 UTC,"postgres","postgres",4429,"192.168.56.1:55863",62751052.114d,2,"idle",2022-05-06 12:10:58 UTC,4/1253,0,LOG,00000,"statement: 



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:10:58.602 UTC,,,1347,,6273c873.543,46,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:10:58.633 UTC,"postgres","postgres",4429,"192.168.56.1:55863",62751052.114d,3,"CREATE TABLE",2022-05-06 12:10:58 UTC,4/1253,948,ERROR,42P07,"relation ""payments_q3_2017"" already exists",,,,,,"



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:10:59.539 UTC,"postgres","postgres",4429,"192.168.56.1:55863",62751052.114d,4,"idle",2022-05-06 12:10:58 UTC,4/1254,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:10:59.544 UTC,"postgres","postgres",4429,"192.168.56.1:55863",62751052.114d,5,"idle",2022-05-06 12:10:58 UTC,4/1255,0,LOG,00000,"statement: 



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:10:59.544 UTC,,,1347,,6273c873.543,47,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:10:59.585 UTC,"postgres","postgres",4429,"192.168.56.1:55863",62751052.114d,6,"CREATE TABLE",2022-05-06 12:10:58 UTC,4/1255,949,ERROR,42P07,"relation ""payments_q3_2017"" already exists",,,,,,"



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:10:59.987 UTC,"postgres","postgres",4429,"192.168.56.1:55863",62751052.114d,7,"idle",2022-05-06 12:10:58 UTC,4/1256,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:10:59.996 UTC,"postgres","postgres",4429,"192.168.56.1:55863",62751052.114d,8,"idle",2022-05-06 12:10:58 UTC,4/1257,0,LOG,00000,"statement: 



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:10:59.996 UTC,,,1347,,6273c873.543,48,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:11:00.057 UTC,"postgres","postgres",4429,"192.168.56.1:55863",62751052.114d,9,"CREATE TABLE",2022-05-06 12:10:58 UTC,4/1257,950,ERROR,42P07,"relation ""payments_q3_2017"" already exists",,,,,,"



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:11:25.720 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,1,"idle",2022-05-06 12:11:25 UTC,4/1259,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:11:25.722 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,2,"idle",2022-05-06 12:11:25 UTC,4/1260,0,LOG,00000,"statement:   CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');
",,,,,,,,,"","client backend",,0
2022-05-06 12:11:25.722 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,3,"CREATE TABLE",2022-05-06 12:11:25 UTC,4/1260,0,ERROR,42P01,"relation ""allemployees.payments"" does not exist",,,,,,"  CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');
",,,"","client backend",,0
2022-05-06 12:11:32.426 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,4,"idle",2022-05-06 12:11:25 UTC,4/1261,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:11:32.434 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,5,"idle",2022-05-06 12:11:25 UTC,4/1262,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;










/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:11:32.434 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,6,"DROP TABLE",2022-05-06 12:11:25 UTC,4/1262,0,ERROR,42P01,"table ""payments"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;










/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:11:44.345 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,7,"idle",2022-05-06 12:11:25 UTC,4/1263,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:11:44.352 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,8,"idle",2022-05-06 12:11:25 UTC,4/1264,0,LOG,00000,"statement: 


/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:11:44.352 UTC,,,1347,,6273c873.543,49,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:11:44.387 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,9,"CREATE TABLE",2022-05-06 12:11:25 UTC,4/1264,951,ERROR,42P07,"relation ""payments_q3_2017"" already exists",,,,,,"


/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:11:44.952 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,10,"idle",2022-05-06 12:11:25 UTC,4/1265,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:11:44.954 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,11,"idle",2022-05-06 12:11:25 UTC,4/1266,0,LOG,00000,"statement: 


/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:11:44.955 UTC,,,1347,,6273c873.543,50,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:11:45.004 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,12,"CREATE TABLE",2022-05-06 12:11:25 UTC,4/1266,952,ERROR,42P07,"relation ""payments_q3_2017"" already exists",,,,,,"


/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:11:45.227 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,13,"idle",2022-05-06 12:11:25 UTC,4/1267,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:11:45.231 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,14,"idle",2022-05-06 12:11:25 UTC,4/1268,0,LOG,00000,"statement: 


/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:11:45.231 UTC,,,1347,,6273c873.543,51,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:11:45.276 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,15,"CREATE TABLE",2022-05-06 12:11:25 UTC,4/1268,953,ERROR,42P07,"relation ""payments_q3_2017"" already exists",,,,,,"


/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:11:45.486 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,16,"idle",2022-05-06 12:11:25 UTC,4/1269,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:11:45.489 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,17,"idle",2022-05-06 12:11:25 UTC,4/1270,0,LOG,00000,"statement: 


/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:11:45.489 UTC,,,1347,,6273c873.543,52,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:11:45.527 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,18,"CREATE TABLE",2022-05-06 12:11:25 UTC,4/1270,954,ERROR,42P07,"relation ""payments_q3_2017"" already exists",,,,,,"


/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:11:52.143 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,19,"idle",2022-05-06 12:11:25 UTC,4/1271,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:11:52.145 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,20,"idle",2022-05-06 12:11:25 UTC,4/1272,0,LOG,00000,"statement: DROP TABLE payments_q3_2017;",,,,,,,,,"","client backend",,0
2022-05-06 12:11:52.146 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,21,"DROP TABLE",2022-05-06 12:11:25 UTC,4/1272,0,ERROR,42P01,"table ""payments_q3_2017"" does not exist",,,,,,"DROP TABLE payments_q3_2017;",,,"","client backend",,0
2022-05-06 12:11:58.487 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,22,"idle",2022-05-06 12:11:25 UTC,4/1273,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:11:58.493 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,23,"idle",2022-05-06 12:11:25 UTC,4/1274,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;










/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:11:58.493 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,24,"DROP TABLE",2022-05-06 12:11:25 UTC,4/1274,0,ERROR,42P01,"table ""payments"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;










/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:11:59.404 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,25,"idle",2022-05-06 12:11:25 UTC,4/1275,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:11:59.411 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,26,"idle",2022-05-06 12:11:25 UTC,4/1276,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;










/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:11:59.412 UTC,"postgres","postgres",4430,"192.168.56.1:55867",6275106d.114e,27,"DROP TABLE",2022-05-06 12:11:25 UTC,4/1276,0,ERROR,42P01,"table ""payments"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;










/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:12:20.735 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,1,"idle",2022-05-06 12:12:20 UTC,5/737,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:20.738 UTC,"postgres","postgres",4436,"192.168.56.1:55870",627510a4.1154,1,"idle",2022-05-06 12:12:20 UTC,4/1278,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:12:20.740 UTC,"postgres","postgres",4436,"192.168.56.1:55870",627510a4.1154,2,"idle",2022-05-06 12:12:20 UTC,4/1279,0,LOG,00000,"statement: 
    SELECT
      r.specific_name as id,
      r.routine_schema as routine_schema,
      r.routine_name as name,
      r.routine_type as routine_type,
      r.data_type as data_type
    FROM INFORMATION_SCHEMA.ROUTINES r
    where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    
    ORDER BY routine_schema, routine_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:20.742 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,2,"idle",2022-05-06 12:12:20 UTC,5/738,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:20.746 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,3,"idle",2022-05-06 12:12:20 UTC,5/739,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:12:20.747 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,4,"idle",2022-05-06 12:12:20 UTC,5/740,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:20.748 UTC,"postgres","postgres",4436,"192.168.56.1:55870",627510a4.1154,3,"idle",2022-05-06 12:12:20 UTC,4/1280,0,LOG,00000,"statement: 
    select
        r.routine_schema as routine_schema,
        r.specific_name as specific_name,
        p.parameter_name as parameter_name,
        p.character_maximum_length as char_length,
        p.data_type as data_type
  from information_schema.routines r
  left join information_schema.parameters p
            on p.specific_schema = r.routine_schema
            and p.specific_name = r.specific_name
  where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    

      AND p.parameter_mode = 'IN'
  order by r.routine_schema,
          r.specific_name,
          p.ordinal_position;

  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:20.750 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,5,"idle",2022-05-06 12:12:20 UTC,5/741,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:30.932 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,6,"idle",2022-05-06 12:12:20 UTC,5/742,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:12:30.941 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,7,"idle",2022-05-06 12:12:20 UTC,5/743,0,LOG,00000,"statement: 




/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:12:30.941 UTC,,,1347,,6273c873.543,53,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:12:30.973 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,8,"CREATE TABLE",2022-05-06 12:12:20 UTC,5/743,962,ERROR,42P07,"relation ""payments_q3_2017"" already exists",,,,,,"




/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:12:48.935 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,9,"idle",2022-05-06 12:12:20 UTC,5/744,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:48.940 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,10,"idle",2022-05-06 12:12:20 UTC,5/745,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:48.942 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,11,"idle",2022-05-06 12:12:20 UTC,5/746,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:12:48.943 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,12,"idle",2022-05-06 12:12:20 UTC,5/747,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:48.944 UTC,"postgres","postgres",4438,"192.168.56.1:55871",627510c0.1156,1,"idle",2022-05-06 12:12:48 UTC,4/1282,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:12:48.945 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,13,"idle",2022-05-06 12:12:20 UTC,5/748,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:48.950 UTC,"postgres","postgres",4438,"192.168.56.1:55871",627510c0.1156,2,"idle",2022-05-06 12:12:48 UTC,4/1283,0,LOG,00000,"statement: 
    SELECT
      r.specific_name as id,
      r.routine_schema as routine_schema,
      r.routine_name as name,
      r.routine_type as routine_type,
      r.data_type as data_type
    FROM INFORMATION_SCHEMA.ROUTINES r
    where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    
    ORDER BY routine_schema, routine_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:48.961 UTC,"postgres","postgres",4438,"192.168.56.1:55871",627510c0.1156,3,"idle",2022-05-06 12:12:48 UTC,4/1284,0,LOG,00000,"statement: 
    select
        r.routine_schema as routine_schema,
        r.specific_name as specific_name,
        p.parameter_name as parameter_name,
        p.character_maximum_length as char_length,
        p.data_type as data_type
  from information_schema.routines r
  left join information_schema.parameters p
            on p.specific_schema = r.routine_schema
            and p.specific_name = r.specific_name
  where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    

      AND p.parameter_mode = 'IN'
  order by r.routine_schema,
          r.specific_name,
          p.ordinal_position;

  ",,,,,,,,,"","client backend",,0
2022-05-06 12:12:52.129 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,14,"idle",2022-05-06 12:12:20 UTC,5/749,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:12:52.150 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,15,"idle",2022-05-06 12:12:20 UTC,5/750,0,LOG,00000,"statement: 
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');
",,,,,,,,,"","client backend",,0
2022-05-06 12:12:52.151 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,16,"CREATE TABLE",2022-05-06 12:12:20 UTC,5/750,0,ERROR,42P01,"relation ""allemployees.performancereview"" does not exist",,,,,,"
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');
",,,"","client backend",,0
2022-05-06 12:13:06.063 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,17,"idle",2022-05-06 12:12:20 UTC,5/751,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:13:06.088 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,18,"idle",2022-05-06 12:12:20 UTC,5/752,0,LOG,00000,"statement: 
CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:06.155 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,19,"idle",2022-05-06 12:12:20 UTC,5/753,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:06.161 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,20,"idle",2022-05-06 12:12:20 UTC,5/754,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:06.164 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,21,"idle",2022-05-06 12:12:20 UTC,5/755,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:13:06.165 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,22,"idle",2022-05-06 12:12:20 UTC,5/756,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:06.166 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,23,"idle",2022-05-06 12:12:20 UTC,5/757,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:11.892 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,24,"idle",2022-05-06 12:12:20 UTC,5/758,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:13:11.895 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,25,"idle",2022-05-06 12:12:20 UTC,5/759,0,LOG,00000,"statement: 
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');
",,,,,,,,,"","client backend",,0
2022-05-06 12:13:11.935 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,26,"idle",2022-05-06 12:12:20 UTC,5/760,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:11.940 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,27,"idle",2022-05-06 12:12:20 UTC,5/761,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:11.942 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,28,"idle",2022-05-06 12:12:20 UTC,5/762,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:13:11.943 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,29,"idle",2022-05-06 12:12:20 UTC,5/763,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:11.945 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,30,"idle",2022-05-06 12:12:20 UTC,5/764,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:16.813 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,31,"idle",2022-05-06 12:12:20 UTC,5/765,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:13:16.836 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,32,"idle",2022-05-06 12:12:20 UTC,5/766,0,LOG,00000,"statement: 
  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');
",,,,,,,,,"","client backend",,0
2022-05-06 12:13:16.866 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,33,"idle",2022-05-06 12:12:20 UTC,5/767,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:16.873 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,34,"idle",2022-05-06 12:12:20 UTC,5/768,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:16.875 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,35,"idle",2022-05-06 12:12:20 UTC,5/769,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:13:16.876 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,36,"idle",2022-05-06 12:12:20 UTC,5/770,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:16.877 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,37,"idle",2022-05-06 12:12:20 UTC,5/771,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:31.096 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,38,"idle",2022-05-06 12:12:20 UTC,5/772,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:13:31.104 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,39,"idle",2022-05-06 12:12:20 UTC,5/773,0,ERROR,42601,"syntax error at end of input",,,,,,"
	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE",509,,"","client backend",,0
2022-05-06 12:13:37.223 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,40,"idle",2022-05-06 12:12:20 UTC,5/774,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:13:37.245 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,41,"idle",2022-05-06 12:12:20 UTC,5/775,0,LOG,00000,"statement: 	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');
",,,,,,,,,"","client backend",,0
2022-05-06 12:13:37.267 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,42,"idle",2022-05-06 12:12:20 UTC,5/776,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:37.270 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,43,"idle",2022-05-06 12:12:20 UTC,5/777,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:37.274 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,44,"idle",2022-05-06 12:12:20 UTC,5/778,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:13:37.275 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,45,"idle",2022-05-06 12:12:20 UTC,5/779,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:37.276 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,46,"idle",2022-05-06 12:12:20 UTC,5/780,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:41.169 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,47,"idle",2022-05-06 12:12:20 UTC,5/781,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:13:41.178 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,48,"idle",2022-05-06 12:12:20 UTC,5/782,0,LOG,00000,"statement: 
	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');
",,,,,,,,,"","client backend",,0
2022-05-06 12:13:41.212 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,49,"idle",2022-05-06 12:12:20 UTC,5/783,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:41.218 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,50,"idle",2022-05-06 12:12:20 UTC,5/784,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:41.223 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,51,"idle",2022-05-06 12:12:20 UTC,5/785,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:13:41.224 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,52,"idle",2022-05-06 12:12:20 UTC,5/786,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:41.226 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,53,"idle",2022-05-06 12:12:20 UTC,5/787,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:13:44.440 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,54,"idle",2022-05-06 12:12:20 UTC,5/788,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:13:44.444 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,55,"idle",2022-05-06 12:12:20 UTC,5/789,0,LOG,00000,"statement: 
	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');
",,,,,,,,,"","client backend",,0
2022-05-06 12:13:44.444 UTC,"postgres","postgres",4435,"192.168.56.1:55869",627510a4.1153,56,"CREATE TABLE",2022-05-06 12:12:20 UTC,5/789,970,ERROR,42P07,"relation ""payments_q1_2019"" already exists",,,,,,"
	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');
",,,"","client backend",,0
2022-05-06 12:14:15.158 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,1,"idle",2022-05-06 12:14:15 UTC,4/1294,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:14:15.159 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,2,"idle",2022-05-06 12:14:15 UTC,4/1295,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;










/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:14:15.167 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,3,"DROP TABLE",2022-05-06 12:14:15 UTC,4/1295,971,ERROR,42P01,"table ""stores"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;










/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:14:24.294 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,4,"idle",2022-05-06 12:14:15 UTC,4/1296,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:14:24.298 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,5,"idle",2022-05-06 12:14:15 UTC,4/1297,0,LOG,00000,"statement: 

/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:14:24.299 UTC,,,1347,,6273c873.543,54,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:14:24.310 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,6,"ALTER TABLE",2022-05-06 12:14:15 UTC,4/1297,972,ERROR,42P07,"relation ""stores"" already exists in schema ""allemployees""",,,,,,"

/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:14:33.133 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,7,"idle",2022-05-06 12:14:15 UTC,4/1298,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:14:33.163 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,8,"idle",2022-05-06 12:14:15 UTC,4/1299,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;


",,,,,,,,,"","client backend",,0
2022-05-06 12:14:33.170 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,9,"DROP TABLE",2022-05-06 12:14:15 UTC,4/1299,973,ERROR,42P01,"table ""stores"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;


",,,"","client backend",,0
2022-05-06 12:14:33.789 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,10,"idle",2022-05-06 12:14:15 UTC,4/1300,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:14:33.796 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,11,"idle",2022-05-06 12:14:15 UTC,4/1301,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;


",,,,,,,,,"","client backend",,0
2022-05-06 12:14:33.805 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,12,"DROP TABLE",2022-05-06 12:14:15 UTC,4/1301,974,ERROR,42P01,"table ""stores"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;


DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;


",,,"","client backend",,0
2022-05-06 12:14:35.979 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,13,"idle",2022-05-06 12:14:15 UTC,4/1302,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:14:35.988 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,14,"idle",2022-05-06 12:14:15 UTC,4/1303,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:14:35.992 UTC,"postgres","postgres",4444,"192.168.56.1:55880",6275112b.115c,1,"idle",2022-05-06 12:14:35 UTC,5/791,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:14:35.993 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,15,"idle",2022-05-06 12:14:15 UTC,4/1304,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:14:35.995 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,16,"idle",2022-05-06 12:14:15 UTC,4/1305,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:14:35.998 UTC,"postgres","postgres",4444,"192.168.56.1:55880",6275112b.115c,2,"idle",2022-05-06 12:14:35 UTC,5/792,0,LOG,00000,"statement: 
    SELECT
      r.specific_name as id,
      r.routine_schema as routine_schema,
      r.routine_name as name,
      r.routine_type as routine_type,
      r.data_type as data_type
    FROM INFORMATION_SCHEMA.ROUTINES r
    where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    
    ORDER BY routine_schema, routine_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:14:36.002 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,17,"idle",2022-05-06 12:14:15 UTC,4/1306,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:14:36.009 UTC,"postgres","postgres",4444,"192.168.56.1:55880",6275112b.115c,3,"idle",2022-05-06 12:14:35 UTC,5/793,0,LOG,00000,"statement: 
    select
        r.routine_schema as routine_schema,
        r.specific_name as specific_name,
        p.parameter_name as parameter_name,
        p.character_maximum_length as char_length,
        p.data_type as data_type
  from information_schema.routines r
  left join information_schema.parameters p
            on p.specific_schema = r.routine_schema
            and p.specific_name = r.specific_name
  where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    

      AND p.parameter_mode = 'IN'
  order by r.routine_schema,
          r.specific_name,
          p.ordinal_position;

  ",,,,,,,,,"","client backend",,0
2022-05-06 12:14:53.762 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,18,"idle",2022-05-06 12:14:15 UTC,4/1307,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:14:53.793 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,19,"idle",2022-05-06 12:14:15 UTC,4/1308,0,LOG,00000,"statement: 
DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;









",,,,,,,,,"","client backend",,0
2022-05-06 12:14:53.798 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,20,"DROP TABLE",2022-05-06 12:14:15 UTC,4/1308,975,ERROR,42P01,"table ""payments_q1_2020"" does not exist",,,,,,"
DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;









",,,"","client backend",,0
2022-05-06 12:14:54.676 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,21,"idle",2022-05-06 12:14:15 UTC,4/1309,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:14:54.680 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,22,"idle",2022-05-06 12:14:15 UTC,4/1310,0,LOG,00000,"statement: 
DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;









",,,,,,,,,"","client backend",,0
2022-05-06 12:14:54.686 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,23,"DROP TABLE",2022-05-06 12:14:15 UTC,4/1310,977,ERROR,42P01,"table ""payments_q1_2020"" does not exist",,,,,,"
DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;









",,,"","client backend",,0
2022-05-06 12:14:54.900 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,24,"idle",2022-05-06 12:14:15 UTC,4/1311,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:14:54.906 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,25,"idle",2022-05-06 12:14:15 UTC,4/1312,0,LOG,00000,"statement: 
DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;









",,,,,,,,,"","client backend",,0
2022-05-06 12:14:54.915 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,26,"DROP TABLE",2022-05-06 12:14:15 UTC,4/1312,978,ERROR,42P01,"table ""payments_q1_2020"" does not exist",,,,,,"
DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;









",,,"","client backend",,0
2022-05-06 12:14:55.084 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,27,"idle",2022-05-06 12:14:15 UTC,4/1313,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:14:55.087 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,28,"idle",2022-05-06 12:14:15 UTC,4/1314,0,LOG,00000,"statement: 
DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;









",,,,,,,,,"","client backend",,0
2022-05-06 12:14:55.094 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,29,"DROP TABLE",2022-05-06 12:14:15 UTC,4/1314,979,ERROR,42P01,"table ""payments_q1_2020"" does not exist",,,,,,"
DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;









",,,"","client backend",,0
2022-05-06 12:14:55.296 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,30,"idle",2022-05-06 12:14:15 UTC,4/1315,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:14:55.302 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,31,"idle",2022-05-06 12:14:15 UTC,4/1316,0,LOG,00000,"statement: 
DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;









",,,,,,,,,"","client backend",,0
2022-05-06 12:14:55.309 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,32,"DROP TABLE",2022-05-06 12:14:15 UTC,4/1316,980,ERROR,42P01,"table ""payments_q1_2020"" does not exist",,,,,,"
DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;









",,,"","client backend",,0
2022-05-06 12:15:00.439 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,33,"idle",2022-05-06 12:14:15 UTC,4/1317,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:15:00.449 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,34,"idle",2022-05-06 12:14:15 UTC,4/1318,0,LOG,00000,"statement: DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;",,,,,,,,,"","client backend",,0
2022-05-06 12:15:03.393 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,35,"idle",2022-05-06 12:14:15 UTC,4/1319,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:15:03.399 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,36,"idle",2022-05-06 12:14:15 UTC,4/1320,0,LOG,00000,"statement: DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;",,,,,,,,,"","client backend",,0
2022-05-06 12:15:03.399 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,37,"DROP TABLE",2022-05-06 12:14:15 UTC,4/1320,0,ERROR,42P01,"table ""payments_q4_2018"" does not exist",,,,,,"DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;",,,"","client backend",,0
2022-05-06 12:15:06.432 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,38,"idle",2022-05-06 12:14:15 UTC,4/1321,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:15:06.458 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,39,"idle",2022-05-06 12:14:15 UTC,4/1322,0,LOG,00000,"statement: DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;",,,,,,,,,"","client backend",,0
2022-05-06 12:15:10.310 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,40,"idle",2022-05-06 12:14:15 UTC,4/1323,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:15:10.312 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,41,"idle",2022-05-06 12:14:15 UTC,4/1324,0,LOG,00000,"statement: DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;",,,,,,,,,"","client backend",,0
2022-05-06 12:15:10.314 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,42,"DROP TABLE",2022-05-06 12:14:15 UTC,4/1324,983,ERROR,42P01,"table ""payments_q3_2019"" does not exist",,,,,,"DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;",,,"","client backend",,0
2022-05-06 12:15:14.179 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,43,"idle",2022-05-06 12:14:15 UTC,4/1325,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:15:14.181 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,44,"idle",2022-05-06 12:14:15 UTC,4/1326,0,LOG,00000,"statement: DROP TABLE payments_q2_2019;",,,,,,,,,"","client backend",,0
2022-05-06 12:15:16.518 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,45,"idle",2022-05-06 12:14:15 UTC,4/1327,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:16.523 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,46,"idle",2022-05-06 12:14:15 UTC,4/1328,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:16.525 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,47,"idle",2022-05-06 12:14:15 UTC,4/1329,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:15:16.525 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,48,"idle",2022-05-06 12:14:15 UTC,4/1330,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:16.527 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,49,"idle",2022-05-06 12:14:15 UTC,4/1331,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:16.535 UTC,"postgres","postgres",4450,"192.168.56.1:55887",62751154.1162,1,"idle",2022-05-06 12:15:16 UTC,5/795,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:15:16.535 UTC,"postgres","postgres",4450,"192.168.56.1:55887",62751154.1162,2,"idle",2022-05-06 12:15:16 UTC,5/796,0,LOG,00000,"statement: 
    SELECT
      r.specific_name as id,
      r.routine_schema as routine_schema,
      r.routine_name as name,
      r.routine_type as routine_type,
      r.data_type as data_type
    FROM INFORMATION_SCHEMA.ROUTINES r
    where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    
    ORDER BY routine_schema, routine_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:16.546 UTC,"postgres","postgres",4450,"192.168.56.1:55887",62751154.1162,3,"idle",2022-05-06 12:15:16 UTC,5/797,0,LOG,00000,"statement: 
    select
        r.routine_schema as routine_schema,
        r.specific_name as specific_name,
        p.parameter_name as parameter_name,
        p.character_maximum_length as char_length,
        p.data_type as data_type
  from information_schema.routines r
  left join information_schema.parameters p
            on p.specific_schema = r.routine_schema
            and p.specific_name = r.specific_name
  where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    

      AND p.parameter_mode = 'IN'
  order by r.routine_schema,
          r.specific_name,
          p.ordinal_position;

  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:21.952 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,50,"idle",2022-05-06 12:14:15 UTC,4/1332,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:15:21.973 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,51,"idle",2022-05-06 12:14:15 UTC,4/1333,0,LOG,00000,"statement: DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;",,,,,,,,,"","client backend",,0
2022-05-06 12:15:25.057 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,52,"idle",2022-05-06 12:14:15 UTC,4/1334,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:15:25.065 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,53,"idle",2022-05-06 12:14:15 UTC,4/1335,0,LOG,00000,"statement: DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;",,,,,,,,,"","client backend",,0
2022-05-06 12:15:28.045 UTC,"postgres","postgres",4450,"192.168.56.1:55887",62751154.1162,4,"idle",2022-05-06 12:15:16 UTC,5/798,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:15:28.045 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,54,"idle",2022-05-06 12:14:15 UTC,4/1336,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:28.046 UTC,"postgres","postgres",4450,"192.168.56.1:55887",62751154.1162,5,"idle",2022-05-06 12:15:16 UTC,5/799,0,LOG,00000,"statement: 
    SELECT
      r.specific_name as id,
      r.routine_schema as routine_schema,
      r.routine_name as name,
      r.routine_type as routine_type,
      r.data_type as data_type
    FROM INFORMATION_SCHEMA.ROUTINES r
    where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    
    ORDER BY routine_schema, routine_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:28.049 UTC,"postgres","postgres",4450,"192.168.56.1:55887",62751154.1162,6,"idle",2022-05-06 12:15:16 UTC,5/800,0,LOG,00000,"statement: 
    select
        r.routine_schema as routine_schema,
        r.specific_name as specific_name,
        p.parameter_name as parameter_name,
        p.character_maximum_length as char_length,
        p.data_type as data_type
  from information_schema.routines r
  left join information_schema.parameters p
            on p.specific_schema = r.routine_schema
            and p.specific_name = r.specific_name
  where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    

      AND p.parameter_mode = 'IN'
  order by r.routine_schema,
          r.specific_name,
          p.ordinal_position;

  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:28.055 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,55,"idle",2022-05-06 12:14:15 UTC,4/1337,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:28.056 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,56,"idle",2022-05-06 12:14:15 UTC,4/1338,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:15:28.058 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,57,"idle",2022-05-06 12:14:15 UTC,4/1339,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:28.059 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,58,"idle",2022-05-06 12:14:15 UTC,4/1340,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:38.976 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,59,"idle",2022-05-06 12:14:15 UTC,4/1341,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:15:38.984 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,60,"idle",2022-05-06 12:14:15 UTC,4/1342,0,LOG,00000,"statement: DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; ",,,,,,,,,"","client backend",,0
2022-05-06 12:15:38.985 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,61,"DROP TABLE",2022-05-06 12:14:15 UTC,4/1342,0,ERROR,42P01,"table ""stores"" does not exist",,,,,,"DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; ",,,"","client backend",,0
2022-05-06 12:15:57.798 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,62,"idle",2022-05-06 12:14:15 UTC,4/1343,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:15:57.805 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,63,"idle",2022-05-06 12:14:15 UTC,4/1344,0,LOG,00000,"statement: 
DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;",,,,,,,,,"","client backend",,0
2022-05-06 12:16:00.362 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,64,"idle",2022-05-06 12:14:15 UTC,4/1345,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:16:00.365 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,65,"idle",2022-05-06 12:14:15 UTC,4/1346,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:16:00.367 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,66,"idle",2022-05-06 12:14:15 UTC,4/1347,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:16:00.368 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,67,"idle",2022-05-06 12:14:15 UTC,4/1348,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:16:00.369 UTC,"postgres","postgres",4443,"192.168.56.1:55875",62751117.115b,68,"idle",2022-05-06 12:14:15 UTC,4/1349,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:16:00.383 UTC,"postgres","postgres",4454,"192.168.56.1:55889",62751180.1166,1,"idle",2022-05-06 12:16:00 UTC,5/811,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:16:00.385 UTC,"postgres","postgres",4454,"192.168.56.1:55889",62751180.1166,2,"idle",2022-05-06 12:16:00 UTC,5/812,0,LOG,00000,"statement: 
    SELECT
      r.specific_name as id,
      r.routine_schema as routine_schema,
      r.routine_name as name,
      r.routine_type as routine_type,
      r.data_type as data_type
    FROM INFORMATION_SCHEMA.ROUTINES r
    where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    
    ORDER BY routine_schema, routine_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:16:00.394 UTC,"postgres","postgres",4454,"192.168.56.1:55889",62751180.1166,3,"idle",2022-05-06 12:16:00 UTC,5/813,0,LOG,00000,"statement: 
    select
        r.routine_schema as routine_schema,
        r.specific_name as specific_name,
        p.parameter_name as parameter_name,
        p.character_maximum_length as char_length,
        p.data_type as data_type
  from information_schema.routines r
  left join information_schema.parameters p
            on p.specific_schema = r.routine_schema
            and p.specific_name = r.specific_name
  where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    

      AND p.parameter_mode = 'IN'
  order by r.routine_schema,
          r.specific_name,
          p.ordinal_position;

  ",,,,,,,,,"","client backend",,0
2022-05-06 12:16:47.498 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,1,"idle",2022-05-06 12:16:47 UTC,4/1353,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:16:47.501 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,2,"idle",2022-05-06 12:16:47 UTC,4/1354,0,LOG,00000,"statement: 



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:16:47.502 UTC,,,1347,,6273c873.543,55,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:16:47.539 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,3,"CREATE ROLE",2022-05-06 12:16:47 UTC,4/1354,992,ERROR,42710,"role ""hrstaff"" already exists",,,,,,"



/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,"","client backend",,0
2022-05-06 12:16:54.776 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,4,"idle",2022-05-06 12:16:47 UTC,4/1355,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:16:54.801 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,5,"idle",2022-05-06 12:16:47 UTC,4/1356,0,LOG,00000,"statement: 
DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;
",,,,,,,,,"","client backend",,0
2022-05-06 12:17:03.342 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,6,"idle",2022-05-06 12:16:47 UTC,4/1357,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 12:17:03.364 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,7,"idle",2022-05-06 12:16:47 UTC,4/1358,0,LOG,00000,"statement: 
/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;
CREATE EXTENSION IF NOT EXISTS pgaudit;
CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  	
  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure';
  
   
  
  
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.performancereview, allemployees.payments, allemployees.employees  
   TO HRStaff;
   
   
   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   


",,,,,,,,,"","client backend",,0
2022-05-06 12:17:03.364 UTC,,,1347,,6273c873.543,56,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 12:17:03.468 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,8,"idle",2022-05-06 12:16:47 UTC,4/1359,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:17:03.477 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,9,"idle",2022-05-06 12:16:47 UTC,4/1360,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:17:03.479 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,10,"idle",2022-05-06 12:16:47 UTC,4/1361,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 12:17:03.480 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,11,"idle",2022-05-06 12:16:47 UTC,4/1362,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 12:17:03.483 UTC,"postgres","postgres",4457,"192.168.56.1:55891",627511af.1169,12,"idle",2022-05-06 12:16:47 UTC,4/1363,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 14:07:57.757 UTC,"postgres","postgres",5123,"192.168.56.1:56522",62752bbd.1403,1,"idle",2022-05-06 14:07:57 UTC,4/1826,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:07:57.761 UTC,"postgres","postgres",5123,"192.168.56.1:56522",62752bbd.1403,2,"idle",2022-05-06 14:07:57 UTC,4/1827,0,LOG,00000,"statement:     CREATE INDEX employee_index on allemployees.employees using btree ( emp_id );
",,,,,,,,,"","client backend",,0
2022-05-06 14:39:51.723 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,1,"idle",2022-05-06 14:39:51 UTC,4/1955,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:39:51.730 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,2,"idle",2022-05-06 14:39:51 UTC,4/1956,0,LOG,00000,"statement: 


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;

/*
DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 
*/

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;










/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;



CREATE EXTENSION IF NOT EXISTS pgaudit;



CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure' VALID UNTIL '2023-01-01';;;
  
   
  
  
   GRANT SELECT, INSERT, UPDATE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.employees
   TO HRStaff;
   
   
   

   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   

	--CREATE INDEX
    
    --CREATE INDEX employee_index on allemployees.employees using btree ( emp_id );

  
  	

",,,,,,,,,"","client backend",,0
2022-05-06 14:39:51.765 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,3,"DROP TABLE",2022-05-06 14:39:51 UTC,4/1956,1001,ERROR,42P01,"table ""pr_2017"" does not exist",,,,,,"


DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;

DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;

/*
DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 
*/

DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;

DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;

DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;










/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;



CREATE EXTENSION IF NOT EXISTS pgaudit;



CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure' VALID UNTIL '2023-01-01';;;
  
   
  
  
   GRANT SELECT, INSERT, UPDATE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.employees
   TO HRStaff;
   
   
   

   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   

	--CREATE INDEX
    
    --CREATE INDEX employee_index on allemployees.employees using btree ( emp_id );

  
  	

",,,"","client backend",,0
2022-05-06 14:40:06.622 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,4,"idle",2022-05-06 14:39:51 UTC,4/1957,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:40:06.634 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,5,"idle",2022-05-06 14:39:51 UTC,4/1958,0,LOG,00000,"statement: 





/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;



CREATE EXTENSION IF NOT EXISTS pgaudit;



CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure' VALID UNTIL '2023-01-01';;;
  
   
  
  
   GRANT SELECT, INSERT, UPDATE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.employees
   TO HRStaff;
   
   
   

   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   

	--CREATE INDEX
    
    --CREATE INDEX employee_index on allemployees.employees using btree ( emp_id );

  
  	

",,,,,,,,,"","client backend",,0
2022-05-06 14:40:06.635 UTC,,,1347,,6273c873.543,57,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 14:40:06.654 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,6,"ALTER TABLE",2022-05-06 14:39:51 UTC,4/1958,1002,ERROR,42P07,"relation ""stores"" already exists in schema ""allemployees""",,,,,,"





/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;



CREATE EXTENSION IF NOT EXISTS pgaudit;



CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure' VALID UNTIL '2023-01-01';;;
  
   
  
  
   GRANT SELECT, INSERT, UPDATE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.employees
   TO HRStaff;
   
   
   

   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   

	--CREATE INDEX
    
    --CREATE INDEX employee_index on allemployees.employees using btree ( emp_id );

  
  	

",,,"","client backend",,0
2022-05-06 14:40:09.526 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,7,"idle",2022-05-06 14:39:51 UTC,4/1959,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:40:09.545 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,8,"idle",2022-05-06 14:39:51 UTC,4/1960,0,LOG,00000,"statement: 





/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;



CREATE EXTENSION IF NOT EXISTS pgaudit;



CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure' VALID UNTIL '2023-01-01';;;
  
   
  
  
   GRANT SELECT, INSERT, UPDATE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.employees
   TO HRStaff;
   
   
   

   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   

	--CREATE INDEX
    
    --CREATE INDEX employee_index on allemployees.employees using btree ( emp_id );

  
  	

",,,,,,,,,"","client backend",,0
2022-05-06 14:40:09.545 UTC,,,1347,,6273c873.543,58,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 14:40:09.556 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,9,"ALTER TABLE",2022-05-06 14:39:51 UTC,4/1960,1003,ERROR,42P07,"relation ""stores"" already exists in schema ""allemployees""",,,,,,"





/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;



CREATE EXTENSION IF NOT EXISTS pgaudit;



CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure' VALID UNTIL '2023-01-01';;;
  
   
  
  
   GRANT SELECT, INSERT, UPDATE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.employees
   TO HRStaff;
   
   
   

   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   

	--CREATE INDEX
    
    --CREATE INDEX employee_index on allemployees.employees using btree ( emp_id );

  
  	

",,,"","client backend",,0
2022-05-06 14:40:28.164 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,10,"idle",2022-05-06 14:39:51 UTC,4/1961,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:40:28.169 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,11,"idle",2022-05-06 14:39:51 UTC,4/1962,0,LOG,00000,"statement: 

DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

",,,,,,,,,"","client backend",,0
2022-05-06 14:40:28.169 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,12,"DROP TABLE",2022-05-06 14:39:51 UTC,4/1962,0,ERROR,42P01,"table ""stores"" does not exist",,,,,,"

DROP TABLE STORES;
DROP TABLE EMPLOYEES;
DROP TABLE PERFROMANCEREVIEW;
DROP TABLE PAYMENTS; 

",,,"","client backend",,0
2022-05-06 14:40:41.241 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,13,"idle",2022-05-06 14:39:51 UTC,4/1963,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:40:41.266 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,14,"idle",2022-05-06 14:39:51 UTC,4/1964,0,LOG,00000,"statement: 
DROP TABLE payments_q1_2018;
DROP TABLE payments_q2_2018;
DROP TABLE payments_q3_2018;
DROP TABLE payments_q4_2018;

DROP TABLE payments_q1_2019;
DROP TABLE payments_q2_2019;
DROP TABLE payments_q3_2019;
DROP TABLE payments_q4_2019;

DROP TABLE payments_q1_2020;
DROP TABLE payments_q2_2020;
DROP TABLE payments_q3_2020;
DROP TABLE payments_q4_2020;


",,,,,,,,,"","client backend",,0
2022-05-06 14:40:48.410 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,15,"idle",2022-05-06 14:39:51 UTC,4/1965,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:40:48.418 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,16,"idle",2022-05-06 14:39:51 UTC,4/1966,0,LOG,00000,"statement: 
DROP TABLE payments_q1_2017;
DROP TABLE payments_q2_2017;
DROP TABLE payments_q3_2017;
DROP TABLE payments_q4_2017;
",,,,,,,,,"","client backend",,0
2022-05-06 14:40:50.685 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,17,"idle",2022-05-06 14:39:51 UTC,4/1967,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 14:40:50.690 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,18,"idle",2022-05-06 14:39:51 UTC,4/1968,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 14:40:50.692 UTC,"postgres","postgres",5252,"192.168.56.1:56706",62753372.1484,1,"idle",2022-05-06 14:40:50 UTC,5/819,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 14:40:50.693 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,19,"idle",2022-05-06 14:39:51 UTC,4/1969,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 14:40:50.693 UTC,"postgres","postgres",5252,"192.168.56.1:56706",62753372.1484,2,"idle",2022-05-06 14:40:50 UTC,5/820,0,LOG,00000,"statement: 
    SELECT
      r.specific_name as id,
      r.routine_schema as routine_schema,
      r.routine_name as name,
      r.routine_type as routine_type,
      r.data_type as data_type
    FROM INFORMATION_SCHEMA.ROUTINES r
    where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    
    ORDER BY routine_schema, routine_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 14:40:50.694 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,20,"idle",2022-05-06 14:39:51 UTC,4/1970,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 14:40:50.697 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,21,"idle",2022-05-06 14:39:51 UTC,4/1971,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
2022-05-06 14:40:50.710 UTC,"postgres","postgres",5252,"192.168.56.1:56706",62753372.1484,3,"idle",2022-05-06 14:40:50 UTC,5/821,0,LOG,00000,"statement: 
    select
        r.routine_schema as routine_schema,
        r.specific_name as specific_name,
        p.parameter_name as parameter_name,
        p.character_maximum_length as char_length,
        p.data_type as data_type
  from information_schema.routines r
  left join information_schema.parameters p
            on p.specific_schema = r.routine_schema
            and p.specific_name = r.specific_name
  where r.routine_schema not in ('sys', 'information_schema',
                                'pg_catalog', 'performance_schema')
    

      AND p.parameter_mode = 'IN'
  order by r.routine_schema,
          r.specific_name,
          p.ordinal_position;

  ",,,,,,,,,"","client backend",,0
2022-05-06 14:40:55.107 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,22,"idle",2022-05-06 14:39:51 UTC,4/1972,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:40:55.112 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,23,"idle",2022-05-06 14:39:51 UTC,4/1973,0,LOG,00000,"statement: 
DROP TABLE pr_2017;
DROP TABLE pr_2018;
DROP TABLE pr_2019;
DROP TABLE pr_2020;",,,,,,,,,"","client backend",,0
2022-05-06 14:41:03.480 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,24,"idle",2022-05-06 14:39:51 UTC,4/1974,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:41:03.506 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,25,"idle",2022-05-06 14:39:51 UTC,4/1975,0,LOG,00000,"statement: 
DROP TABLE allemployees.payments;
drop table allemployees.stores;
DROP TABLE allemployees.performancereview;

DROP TABLE allemployees.EMPLOYEES;
",,,,,,,,,"","client backend",,0
2022-05-06 14:41:09.896 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,26,"idle",2022-05-06 14:39:51 UTC,4/1976,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:41:09.901 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,27,"idle",2022-05-06 14:39:51 UTC,4/1977,0,LOG,00000,"statement: 







/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;



CREATE EXTENSION IF NOT EXISTS pgaudit;



CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure' VALID UNTIL '2023-01-01';;;
  
   
  
  
   GRANT SELECT, INSERT, UPDATE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.employees
   TO HRStaff;
   
   
   

   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   

	--CREATE INDEX
    
    --CREATE INDEX employee_index on allemployees.employees using btree ( emp_id );

  
  	

",,,,,,,,,"","client backend",,0
2022-05-06 14:41:09.902 UTC,,,1347,,6273c873.543,59,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 14:41:09.947 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,28,"CREATE ROLE",2022-05-06 14:39:51 UTC,4/1977,1010,ERROR,42710,"role ""hrstaff"" already exists",,,,,,"







/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;



CREATE EXTENSION IF NOT EXISTS pgaudit;



CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure' VALID UNTIL '2023-01-01';;;
  
   
  
  
   GRANT SELECT, INSERT, UPDATE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.employees
   TO HRStaff;
   
   
   

   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   

	--CREATE INDEX
    
    --CREATE INDEX employee_index on allemployees.employees using btree ( emp_id );

  
  	

",,,"","client backend",,0
2022-05-06 14:41:16.247 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,29,"idle",2022-05-06 14:39:51 UTC,4/1978,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:41:16.251 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,30,"idle",2022-05-06 14:39:51 UTC,4/1979,0,LOG,00000,"statement: 
DROP ROLE HRSTAFF;
DROP ROLE EMPLOYEE;",,,,,,,,,"","client backend",,0
2022-05-06 14:41:22.325 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,31,"idle",2022-05-06 14:39:51 UTC,4/1980,0,LOG,00000,"statement: SELECT pg_backend_pid() AS pid",,,,,,,,,"","client backend",,0
2022-05-06 14:41:22.330 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,32,"idle",2022-05-06 14:39:51 UTC,4/1981,0,LOG,00000,"statement: 




/* Table Set Up */ 
--CREATE SCHEMA allemployees;
SELECT pg_reload_conf();
SELECT * FROM pg_database;
SHOW config_file;



CREATE EXTENSION IF NOT EXISTS pgaudit;



CREATE EXTENSION IF NOT EXISTS pg_cron;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;





CREATE TABLE Employees(
  emp_id VARCHAR(20) PRIMARY KEY,
  emp_name VARCHAR(52),
  datejoined DATE,
  emp_position VARCHAR(20),
  ssnum VARCHAR(20),
  current_sal INTEGER
 );
  
  
 CREATE TABLE Stores( 
   str_id VARCHAR(20),
   str_location VARCHAR(52),
   str_num_employees INTEGER
 );
  
 CREATE TABLE Payments(
   paymenttype VARCHAR(52),
   emp_bank VARCHAR(30),
   status VARCHAR(10),
   emp_id VARCHAR(20),
   date_created DATE
  )PARTITION BY RANGE (date_created);
  ALTER TABLE Payments ADD FOREIGN KEY (emp_id)
  REFERENCES employees(emp_id);
  
  CREATE TABLE PerformanceReview(
    date_created DATE,
    review TEXT,
    reviewrating INTEGER,
    reviewbonus VARCHAR(20),
    emp_id VARCHAR(20)
     
  ) PARTITION BY RANGE (date_created);
  
  
  
  ALTER TABLE performancereview ADD FOREIGN KEY (emp_id)  
  REFERENCES employees(emp_id);
  
   
 ALTER TABLE stores SET SCHEMA allemployees;
 ALTER TABLE performancereview SET SCHEMA allemployees;
 ALTER TABLE payments SET SCHEMA allemployees;
 ALTER TABLE employees SET SCHEMA allemployees;
  
   CREATE TABLE pr_2017 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2017-01-01') TO ('2017-12-31');
   CREATE TABLE pr_2018 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2018-01-01') TO ('2018-12-31');
      CREATE TABLE pr_2019 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2019-01-01') TO ('2019-12-31');
       CREATE TABLE pr_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2020-01-01') TO ('2020-12-31');
           CREATE TABLE p5_2020 PARTITION OF allemployees.performancereview
    FOR VALUES FROM ('2021-01-01') TO ('2021-12-31');

  CREATE TABLE payments_q1_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-01-01') TO ('2017-03-31');
   CREATE TABLE payments_q2_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-04-01') TO ('2017-06-30');
      CREATE TABLE payments_q3_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-07-01') TO ('2017-09-30');
       CREATE TABLE payments_q4_2017 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2017-10-01') TO ('2017-12-31');

	CREATE TABLE payments_q1_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-01-01') TO ('2018-03-31');
   CREATE TABLE payments_q2_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-04-01') TO ('2018-06-30');
      CREATE TABLE payments_q3_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-07-01') TO ('2018-09-30');
       CREATE TABLE payments_q4_2018 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2018-10-01') TO ('2018-12-31');

	CREATE TABLE payments_q1_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-01-01') TO ('2019-03-31');
   CREATE TABLE payments_q2_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-04-01') TO ('2019-06-30');
      CREATE TABLE payments_q3_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-07-01') TO ('2019-09-30');
       CREATE TABLE payments_q4_2019 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2019-10-01') TO ('2019-12-31');

	CREATE TABLE payments_q1_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-01-01') TO ('2020-03-31');
   CREATE TABLE payments_q2_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-04-01') TO ('2020-06-30');
      CREATE TABLE payments_q3_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-07-01') TO ('2020-09-30');
       CREATE TABLE payments_q4_2020 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2020-10-01') TO ('2020-12-31');
	
    CREATE TABLE payments_q1_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-01-01') TO ('2021-03-31');
   CREATE TABLE payments_q2_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-04-01') TO ('2021-06-30');
      CREATE TABLE payments_q3_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-07-01') TO ('2021-09-30');
       CREATE TABLE payments_q4_2021 PARTITION OF allemployees.payments
    FOR VALUES FROM ('2021-10-01') TO ('2021-12-31');

  
  /* Role Set up */ 
 
  CREATE ROLE HRStaff LOGIN PASSWORD 'hrstaffsecure' VALID UNTIL '2023-01-01';;
  CREATE ROLE Employee LOGIN PASSWORD 'employeesecure' VALID UNTIL '2023-01-01';;;
  
   
  
  
   GRANT SELECT, INSERT, UPDATE
   ON allemployees.performancereview, allemployees.payments  
   TO HRStaff;
   
   
   GRANT SELECT, INSERT, UPDATE, DELETE
   ON allemployees.employees
   TO HRStaff;
   
   
   

   
   
   -- INSERTS -----------------------------------
 
   
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DF',
     'Aaron Murphy',
     '01/01/2020',
     'Employee',
     '1426362323',
     109202
   );
    
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DG',
     'Niall McNamara',
     '01/01/2020',
     'Employee',
     '142freufhfe',
     109202
   );
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DH',
     'Robbie Hatfield',
     '01/01/2020',
     'Employee',
     '1423uir243',
     109202
   );
    
     
   INSERT INTO allemployees.employees ( emp_id, emp_name, datejoined, emp_position, ssnum, current_sal) VALUES (
     '1DI',
     'Gabriel Hynes',
     '01/01/2020',
     'HR Staff',
     '14233542323',
     109323
   );
   
   INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '12736A733',
     'PAID',
     '1DF',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     '127SDHD3',
     'PAID',
     '1DH',     
     '01/01/2019'
   );
    INSERT INTO allemployees.payments ( paymenttype , emp_bank, status,emp_id, date_created ) VALUES (
     'CASH',
     --crypt('127SDHD3','emp_sec_key'),
      '127SDHD3',
     'PENDING',
     '1DI',
    '01/01/2019'
   );
   
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     10,
     'BONUS PAY',
     '1DF',
     '2019-05-05'
     );
     
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     0,
     'SACKED',
     '1DG',
     '2018-05-05'
     );
     
        
   INSERT INTO allemployees.performancereview (review, reviewrating, reviewbonus, emp_id, date_created) VALUES (
     'Lorem ipsum dolor sit amet, consectetur adipiscing elit. In at eleifend lectus. Curabitur facilisis laoreet ex, a iaculis dui vehicula a. Nam semper tincidunt luctus. Curabitur condimentum pretium quam, et venenatis neque porttitor nec. Nam at odio sapien. Phasellus vitae dolor viverra, cursus arcu sollicitudin, imperdiet odio. Aliquam erat volutpat. Vivamus vitae ante rutrum, dapibus odio et, mattis felis. Praesent posuere viverra pharetra. Aenean tristique hendrerit lacinia. Proin vestibulum, tellus quis ornare malesuada, elit mi commodo arcu, eu pretium nulla lectus quis nisi.

    Donec tempor pellentesque hendrerit. Aliquam erat volutpat. Cras ultricies dui dolor, vel venenatis est mattis sed. Praesent neque urna, tincidunt ac tincidunt eget, bibendum maximus augue. Vivamus vel magna urna. Aenean sem nisi, vehicula eu lacus et, luctus porttitor leo. Vivamus id nulla orci. Aenean suscipit porta mi vel semper. Nam vestibulum augue fringilla leo dignissim, quis lobortis nisl scelerisque. Phasellus interdum, lorem vitae molestie blandit, felis dui finibus tellus, ac vestibulum felis purus id nibh. Nunc congue suscipit lorem, a tincidunt eros pulvinar sit amet.

    Donec nec elit ut risus eleifend accumsan venenatis quis nibh. Suspendisse vel ullamcorper leo, a consequat leo. Aenean nunc enim, rhoncus vitae lobortis in, blandit a nisi. Nunc vel nibh risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In lobortis nisi a purus tristique elementum. In et sagittis nunc. Cras maximus molestie dapibus. Etiam vitae ultrices libero, vitae bibendum lorem.

    Sed ac luctus justo. Aenean facilisis turpis id velit sagittis, ac blandit nisi tincidunt. Aliquam a lectus in dolor feugiat condimentum. Nulla egestas viverra consectetur. Vivamus enim purus, blandit dignissim lacus eu, interdum lobortis odio. Sed maximus finibus felis ut lobortis. Sed eget blandit purus. Pellentesque sed sapien sed diam porta ornare quis eget nibh.

    Morbi laoreet, eros eu tincidunt blandit, ex massa tristique est, ac dignissim mi mi in tortor. Nulla fringilla volutpat vehicula. Nam pharetra, magna nec auctor porta, lectus sem imperdiet dolor, eget dictum urna orci quis sem. Morbi volutpat tellus nec mi scelerisque interdum. Nulla sed lacus tortor. Vivamus pharetra, tortor et accumsan tincidunt, nisl erat iaculis massa, sed feugiat orci leo ut leo. In hendrerit accumsan pharetra. Mauris non sodales nisi. Fusce elementum ex et lacinia commodo. Proin dignissim varius iaculis. Proin fermentum lacus in tincidunt aliquam. Morbi vitae orci augue.
	',
     5,
     'NOTHING',
     '1DH',
     '2019-05-05'
     );
     
   
   
   --------------------------------------------------------------------------------
    
   
    -- To delete performance reviews after 5 years.
     
    CREATE EXTENSION IF NOT EXISTS pg_cron;
     
    SELECT cron.schedule('DeletePerReview', '30 3 * * 6', $$DELETE FROM allemployees.performancereview WHERE date_created < now() - interval '5 year'$$);
  
    SELECT cron.schedule('DeletePayments', '30 3 * * 6', $$DELETE FROM allemployees.payments WHERE date_created < now() - interval '5 year'$$);

  
  
  
  
  -- Only allow users to view their own employee, payment or performance review files 
  
  ALTER TABLE allemployees.employees ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.performancereview ENABLE ROW LEVEL SECURITY;
  ALTER TABLE allemployees.payments ENABLE ROW LEVEL SECURITY;

  CREATE POLICY emp_view_emp ON allemployees.employees FOR ALL TO Employee USING (allemployees.employees.emp_id = current_user);
  CREATE POLICY emp_view_payment ON allemployees.payments FOR ALL TO Employee USING (allemployees.payments.emp_id = current_user);
  CREATE POLICY emp_view_pr ON allemployees.performancereview FOR ALL TO Employee USING (allemployees.performancereview.emp_id = current_user);






   
   SELECT * FROM allemployees.employees;
   SELECT * FROM allemployees.performancereview JOIN allemployees.employees USING(emp_id);
   SELECT * FROM allemployees.payments JOIN allemployees.employees USING(emp_id);
	

	SELECT * FROM allemployees.employees;
    
    
   

	--CREATE INDEX
    
    --CREATE INDEX employee_index on allemployees.employees using btree ( emp_id );

  
  	

",,,,,,,,,"","client backend",,0
2022-05-06 14:41:22.330 UTC,,,1347,,6273c873.543,60,,2022-05-05 12:52:03 UTC,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,"","postmaster",,0
2022-05-06 14:41:22.445 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,33,"idle",2022-05-06 14:39:51 UTC,4/1982,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.tables
    WHERE table_type NOT LIKE '%VIEW%'
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 14:41:22.453 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,34,"idle",2022-05-06 14:39:51 UTC,4/1983,0,LOG,00000,"statement: 
    SELECT
      table_schema as schema,
      table_name as name
    FROM information_schema.views
    
    ORDER BY table_schema, table_name
  ",,,,,,,,,"","client backend",,0
2022-05-06 14:41:22.455 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,35,"idle",2022-05-06 14:39:51 UTC,4/1984,0,LOG,00000,"statement: select version()",,,,,,,,,"","client backend",,0
2022-05-06 14:41:22.457 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,36,"idle",2022-05-06 14:39:51 UTC,4/1985,0,LOG,00000,"statement: 
    SELECT
      schemaname as schema,
      matviewname as name
    FROM pg_matviews
    
    order by schemaname, matviewname;
  ",,,,,,,,,"","client backend",,0
2022-05-06 14:41:22.460 UTC,"postgres","postgres",5249,"192.168.56.1:56700",62753337.1481,37,"idle",2022-05-06 14:39:51 UTC,4/1986,0,LOG,00000,"statement: 
    SELECT
      table_schema,
      table_name,
      column_name,
      is_nullable,
      ordinal_position,
      column_default,
      CASE
        WHEN character_maximum_length is not null  and udt_name != 'text'
          THEN CONCAT(udt_name, concat('(', concat(character_maximum_length::varchar(255), ')')))
        WHEN datetime_precision is not null THEN
          CONCAT(udt_name, concat('(', concat(datetime_precision::varchar(255), ')')))
        ELSE udt_name
      END as data_type
    FROM information_schema.columns
    
    ORDER BY table_schema, table_name, ordinal_position
  ",,,,,,,,,"","client backend",,0
